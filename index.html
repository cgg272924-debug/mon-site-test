<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OL Match Analyzer - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <nav class="navbar">
            <div class="nav-container">
                <div class="logo">
                    <span class="logo-icon">‚öΩ</span>
                    <span class="logo-text">OL Match Analyzer</span>
                </div>
                <ul class="nav-menu">
                    <li><a href="#home" class="nav-link active">Accueil</a></li>
                    <li><a href="#standings" class="nav-link">Classements</a></li>
                    <li><a href="#matches" class="nav-link">Matchs</a></li>
                    <li><a href="#players" class="nav-link">Joueurs</a></li>
                    <li><a href="#lineups" class="nav-link">Compositions</a></li>
                    <li><a href="#stats" class="nav-link">Statistiques</a></li>
                </ul>
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <section id="home" class="hero">
            <div class="hero-content">
                <h1 class="hero-title">
                    <span class="gradient-text">Analyse Avanc√©e</span>
                    <br>des Matchs OL
                </h1>
                <p class="hero-description">
                    D√©couvrez des insights d√©taill√©s sur les performances, les compositions d'√©quipe 
                    et l'impact des joueurs avec notre plateforme d'analyse de donn√©es.
                </p>
                <div class="hero-buttons">
                    <button class="btn btn-primary">Explorer les Donn√©es</button>
                    <button class="btn btn-secondary">Voir les Statistiques</button>
                </div>
            </div>
            <div class="hero-visual">
                <div class="floating-card card-1">
                    <div class="card-icon">üìä</div>
                    <div class="card-title">Analyse de Matchs</div>
                </div>
                <div class="floating-card card-2">
                    <div class="card-icon">üë•</div>
                    <div class="card-title">Impact des Joueurs</div>
                </div>
                <div class="floating-card card-3">
                    <div class="card-icon">üéØ</div>
                    <div class="card-title">Meilleures Combos</div>
                </div>
            </div>
        </section>

        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üèÜ</div>
                <div class="stat-content">
                    <h3 class="stat-value">1er</h3>
                    <p class="stat-label">Classement Ligue 1</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚öΩ</div>
                <div class="stat-content">
                    <h3 class="stat-value">38</h3>
                    <p class="stat-label">Matchs Analys√©s</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚≠ê</div>
                <div class="stat-content">
                    <h3 class="stat-value">4.8</h3>
                    <p class="stat-label">Note Moyenne</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üî•</div>
                <div class="stat-content">
                    <h3 class="stat-value">15</h3>
                    <p class="stat-label">Combos Optimales</p>
                </div>
            </div>
        </section>

        <section id="react-dashboard" class="section-content">
            <div class="container">
                <h2 class="section-title">R√©sum√© React des Performances</h2>
                <div id="react-root"></div>
            </div>
        </section>

        <section class="features">
            <h2 class="section-title">Fonctionnalit√©s Principales</h2>
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">üìà</div>
                    <h3 class="feature-title">Analyse de Performance</h3>
                    <p class="feature-description">
                        √âvaluation d√©taill√©e des performances de chaque match avec des m√©triques avanc√©es 
                        et des visualisations claires.
                    </p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üë§</div>
                    <h3 class="feature-title">Impact des Joueurs</h3>
                    <p class="feature-description">
                        Mesurez l'impact individuel de chaque joueur sur les r√©sultats de l'√©quipe 
                        avec des analyses pr√©cises.
                    </p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üîÑ</div>
                    <h3 class="feature-title">Combinaisons Optimales</h3>
                    <p class="feature-description">
                        D√©couvrez les meilleures combinaisons de joueurs pour maximiser les performances 
                        de l'√©quipe.
                    </p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üìã</div>
                    <h3 class="feature-title">Gestion des Compositions</h3>
                    <p class="feature-description">
                        Analysez l'impact des diff√©rentes compositions d'√©quipe et optimisez vos choix 
                        tactiques.
                    </p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üìä</div>
                    <h3 class="feature-title">Statistiques D√©taill√©es</h3>
                    <p class="feature-description">
                        Acc√©dez √† des statistiques compl√®tes sur les matchs, les joueurs et les √©quipes 
                        avec des tableaux interactifs.
                    </p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üéØ</div>
                    <h3 class="feature-title">Pr√©dictions de Victoire</h3>
                    <p class="feature-description">
                        Estimez les probabilit√©s de victoire bas√©es sur les donn√©es historiques et 
                        les performances pass√©es.
                    </p>
                </div>
            </div>
        </section>

        <section class="data-preview">
            <h2 class="section-title">Aper√ßu des Donn√©es</h2>
            <div class="preview-container">
                <div class="preview-card">
                    <h3>Matchs R√©cents</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Adversaire</th>
                                    <th>R√©sultat</th>
                                    <th>Note</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>2024-01-15</td>
                                    <td>PSG</td>
                                    <td><span class="badge badge-win">Victoire</span></td>
                                    <td>4.8</td>
                                </tr>
                                <tr>
                                    <td>2024-01-10</td>
                                    <td>Marseille</td>
                                    <td><span class="badge badge-draw">Nul</span></td>
                                    <td>4.2</td>
                                </tr>
                                <tr>
                                    <td>2024-01-05</td>
                                    <td>Monaco</td>
                                    <td><span class="badge badge-win">Victoire</span></td>
                                    <td>4.9</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section Classements -->
        <section id="standings" class="section-content">
            <div class="container">
                <h2 class="section-title">Classement Ligue 1</h2>
                <div id="standings-react-root" class="mb-6"></div>
                
                <!-- Tabs pour basculer entre G√©n√©ral, Domicile, Ext√©rieur -->
                <div class="standings-tabs">
                    <button class="tab-btn active" data-tab="general">G√©n√©ral</button>
                    <button class="tab-btn" data-tab="home">Domicile</button>
                    <button class="tab-btn" data-tab="away">Ext√©rieur</button>
                </div>

                <!-- Tableau G√©n√©ral -->
                <div id="standings-general" class="standings-table-container tab-content active">
                    <div class="table-container">
                        <table id="standings-general-table" class="standings-table">
                            <thead>
                                <tr>
                                    <th>Rang</th>
                                    <th>√âquipe</th>
                                    <th>MJ</th>
                                    <th>V</th>
                                    <th>N</th>
                                    <th>D</th>
                                    <th>BP</th>
                                    <th>BC</th>
                                    <th>DB</th>
                                    <th>Pts</th>
                                    <th>Pts/M</th>
                                    <th>%Vic</th>
                                    <th>BP/M</th>
                                    <th>BC/M</th>
                                </tr>
                            </thead>
                            <tbody id="standings-general-tbody">
                                <tr>
                                    <td colspan="13" class="loading">Chargement des donn√©es...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tableau Domicile -->
                <div id="standings-home" class="standings-table-container tab-content">
                    <div class="table-container">
                        <table id="standings-home-table" class="standings-table">
                            <thead>
                                <tr>
                                    <th>Rang</th>
                                    <th>√âquipe</th>
                                    <th>MJ</th>
                                    <th>V</th>
                                    <th>N</th>
                                    <th>D</th>
                                    <th>BP</th>
                                    <th>BC</th>
                                    <th>DB</th>
                                    <th>Pts</th>
                                    <th>Pts/M</th>
                                    <th>%Vic</th>
                                    <th>BP/M</th>
                                    <th>BC/M</th>
                                </tr>
                            </thead>
                            <tbody id="standings-home-tbody">
                                <tr>
                                    <td colspan="14" class="loading">Chargement des donn√©es...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tableau Ext√©rieur -->
                <div id="standings-away" class="standings-table-container tab-content">
                    <div class="table-container">
                        <table id="standings-away-table" class="standings-table">
                            <thead>
                                <tr>
                                    <th>Rang</th>
                                    <th>√âquipe</th>
                                    <th>MJ</th>
                                    <th>V</th>
                                    <th>N</th>
                                    <th>D</th>
                                    <th>BP</th>
                                    <th>BC</th>
                                    <th>DB</th>
                                    <th>Pts</th>
                                    <th>Pts/M</th>
                                    <th>%Vic</th>
                                    <th>BP/M</th>
                                    <th>BC/M</th>
                                </tr>
                            </thead>
                            <tbody id="standings-away-tbody">
                                <tr>
                                    <td colspan="14" class="loading">Chargement des donn√©es...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section Matchs -->
        <section id="matches" class="section-content">
            <div class="container">
                <h2 class="section-title">Tous les Matchs</h2>
                <div id="matches-react-root"></div>
            </div>
        </section>

        <!-- Section Joueurs -->
        <section id="players" class="section-content">
            <div class="container">
                <h2 class="section-title">Joueurs Cl√©s</h2>
                <div id="players-react-root"></div>
            </div>
        </section>

        <!-- Section Compositions -->
        <section id="lineups" class="section-content">
            <div class="container">
                <h2 class="section-title">Compositions d'√âquipe</h2>
                <div class="table-container">
                    <table id="lineups-table">
                        <thead>
                            <tr>
                                <th>Match</th>
                                <th>Joueur</th>
                                <th>Position</th>
                                <th>Minutes Jou√©es</th>
                            </tr>
                        </thead>
                        <tbody id="lineups-tbody">
                            <tr>
                                <td colspan="4" class="loading">Chargement des donn√©es...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Section Statistiques -->
        <section id="stats" class="section-content">
            <div class="container">
                <h2 class="section-title">Statistiques D√©taill√©es</h2>
                <div class="stats-grid-detailed">
                    <div class="stat-card-large">
                        <h3>Statistiques des Matchs</h3>
                        <div id="match-stats" class="loading">Chargement...</div>
                    </div>
                    <div class="stat-card-large">
                        <h3>Meilleures Combinaisons</h3>
                        <div id="combo-stats" class="loading">Chargement...</div>
                    </div>
                    <div class="stat-card-large">
                        <h3>OL (FBref, saison en cours)</h3>
                        <div id="ol-fbref-stats" class="loading">Chargement...</div>
                    </div>
                </div>
            </div>
        </section>

        <section id="combos-advanced" class="section-content">
            <div class="container">
                <h2 class="section-title">Combinaisons Avanc√©es de Joueurs</h2>
                <div id="combos-react-root"></div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2024 OL Match Analyzer. Tous droits r√©serv√©s.</p>
            <p class="footer-subtitle">Analyse de donn√©es avanc√©e pour le football</p>
        </div>
    </footer>

    <script src="script.js"></script>
    <script type="text/babel">
        const { useState, useEffect } = React;

        function useCsvData(url) {
            const [state, setState] = useState({
                loading: true,
                error: null,
                rows: []
            });

            useEffect(() => {
                let cancelled = false;

                async function load() {
                    try {
                        const res = await fetch(url);
                        if (!res.ok) {
                            throw new Error('Erreur r√©seau');
                        }
                        const text = await res.text();
                        const parse = typeof parseCSV === 'function' ? parseCSV : null;
                        if (!parse) {
                            throw new Error('parseCSV non disponible');
                        }
                        const rows = parse(text) || [];
                        if (!cancelled) {
                            setState({ loading: false, error: null, rows });
                        }
                    } catch (e) {
                        if (!cancelled) {
                            setState({
                                loading: false,
                                error: e.message || 'Erreur inconnue',
                                rows: []
                            });
                        }
                    }
                }

                load();

                return () => {
                    cancelled = true;
                };
            }, [url]);

            return state;
        }

        function MatchAnalysisDashboard() {
            const {
                loading,
                error,
                rows: matchRows
            } = useCsvData('data/processed/ol_match_score_final.csv');
            const {
                loading: playersLoading,
                error: playersError,
                rows: playerRows
            } = useCsvData('data/processed/ol_key_players.csv');
            const {
                loading: combosLoading,
                error: combosError,
                rows: comboRows
            } = useCsvData('data/processed/ol_best_combos_2_players.csv');

            if (loading || playersLoading || combosLoading) {
                return (
                    <div className="mt-6 rounded-2xl border border-slate-700 bg-slate-900/80 px-6 py-4 text-slate-100 shadow-lg">
                        Chargement des analyses...
                    </div>
                );
            }

            const combinedError = error || playersError || combosError;
            if (combinedError || !matchRows || matchRows.length === 0) {
                return (
                    <div className="mt-6 rounded-2xl border border-red-500/60 bg-red-900/40 px-6 py-4 text-sm text-red-100">
                        {combinedError || 'Impossible d‚Äôafficher le tableau de bord'}
                    </div>
                );
            }

            const matches = matchRows;
            const players = playerRows || [];
            const combos = comboRows || [];

            const totalMatches = matches.length;
            const wins = matches.filter(m => m.result === 'W').length;
            const draws = matches.filter(m => m.result === 'D').length;
            const losses = matches.filter(m => m.result === 'L').length;
            const totalPoints = matches.reduce(
                (sum, m) => sum + (parseInt(m.points || '0', 10) || 0),
                0
            );
            const avgRating =
                matches.reduce(
                    (sum, m) => sum + (parseFloat(m.match_rating || '0') || 0),
                    0
                ) / totalMatches;
            const avgScoreFinal =
                matches.reduce(
                    (sum, m) => sum + (parseFloat(m.score_final || '0') || 0),
                    0
                ) / totalMatches;

            const matchStats = {
                totalMatches,
                wins,
                draws,
                losses,
                totalPoints,
                pointsPerMatch: totalPoints / totalMatches,
                avgRating,
                avgScoreFinal
            };

            const winRate = (wins / totalMatches) * 100;
            const drawRate = (draws / totalMatches) * 100;
            const lossRate = (losses / totalMatches) * 100;

            const topPlayers = players
                .filter(p => p.player)
                .sort(
                    (a, b) =>
                        (parseFloat(b.importance || '0') || 0) -
                        (parseFloat(a.importance || '0') || 0)
                )
                .slice(0, 5)
                .map(p => ({
                    name: p.player,
                    pos: p.pos,
                    minutes: parseInt(p['Playing Time_Min'] || '0', 10) || 0,
                    rating: parseFloat(p.rating || '0') || 0,
                    importance: parseFloat(p.importance || '0') || 0
                }));

            const topCombos = combos
                .filter(c => c.combo)
                .sort(
                    (a, b) =>
                        (parseFloat(b.avg_points || '0') || 0) -
                        (parseFloat(a.avg_points || '0') || 0)
                )
                .slice(0, 5)
                .map(c => ({
                    name: c.combo,
                    matches: parseInt(c.matches || '0', 10) || 0,
                    avgPoints: parseFloat(c.avg_points || '0') || 0,
                    avgScoreFinal: parseFloat(c.avg_score_final || '0') || 0
                }));

            const maxMinutes = topPlayers.reduce(
                (max, p) => (p.minutes > max ? p.minutes : max),
                0
            );

            return (
                <div className="mt-6 space-y-6 rounded-2xl border border-slate-700 bg-slate-900/80 p-6 text-slate-100 shadow-xl">
                    <div className="flex flex-col gap-4 md:flex-row md:items-baseline md:justify-between">
                        <div>
                            <p className="text-xs uppercase tracking-wide text-slate-400">
                                Olympique Lyonnais 2025-2026
                            </p>
                            <h3 className="text-lg font-semibold">
                                Vue d&apos;ensemble avanc√©e des performances
                            </h3>
                        </div>
                        <span className="inline-flex items-center rounded-full bg-emerald-500/10 px-3 py-1 text-xs font-medium text-emerald-300">
                            Donn√©es r√©elles charg√©es depuis plusieurs CSV
                        </span>
                    </div>

                    <div className="grid gap-4 lg:grid-cols-3">
                        <div className="space-y-4 rounded-xl bg-slate-900/60 p-4">
                            <p className="text-xs font-medium uppercase tracking-wide text-slate-400">
                                R√©sum√© des matchs
                            </p>
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <p className="text-xs text-slate-400">
                                        Matchs jou√©s
                                    </p>
                                    <p className="mt-1 text-2xl font-semibold">
                                        {matchStats.totalMatches}
                                    </p>
                                    <p className="mt-1 text-xs text-slate-400">
                                        {matchStats.wins} V ¬∑ {matchStats.draws} N ¬∑ {matchStats.losses} D
                                    </p>
                                </div>
                                <div>
                                    <p className="text-xs text-slate-400">Points</p>
                                    <p className="mt-1 text-2xl font-semibold">
                                        {matchStats.totalPoints}
                                    </p>
                                    <p className="mt-1 text-xs text-slate-400">
                                        {matchStats.pointsPerMatch.toFixed(2)} pts/match
                                    </p>
                                </div>
                                <div>
                                    <p className="text-xs text-slate-400">
                                        Note de match moyenne
                                    </p>
                                    <p className="mt-1 text-2xl font-semibold">
                                        {matchStats.avgRating.toFixed(1)}
                                    </p>
                                    <p className="mt-1 text-xs text-slate-400">
                                        Score interne de performance
                                    </p>
                                </div>
                                <div>
                                    <p className="text-xs text-slate-400">
                                        Score final moyen
                                    </p>
                                    <p className="mt-1 text-2xl font-semibold">
                                        {matchStats.avgScoreFinal.toFixed(1)}
                                    </p>
                                    <p className="mt-1 text-xs text-slate-400">
                                        Indice global de qualit√© de match
                                    </p>
                                </div>
                            </div>
                            <div className="mt-4 space-y-3">
                                <div className="flex items-center justify-between text-xs text-slate-400">
                                    <span>Victoires</span>
                                    <span>{winRate.toFixed(1)}%</span>
                                </div>
                                <div className="h-2 w-full overflow-hidden rounded-full bg-slate-800">
                                    <div
                                        className="h-full rounded-full bg-emerald-500"
                                        style={{ width: `${winRate}%` }}
                                    />
                                </div>
                                <div className="flex items-center justify-between text-xs text-slate-400">
                                    <span>Nuls</span>
                                    <span>{drawRate.toFixed(1)}%</span>
                                </div>
                                <div className="h-2 w-full overflow-hidden rounded-full bg-slate-800">
                                    <div
                                        className="h-full rounded-full bg-amber-400"
                                        style={{ width: `${drawRate}%` }}
                                    />
                                </div>
                                <div className="flex items-center justify-between text-xs text-slate-400">
                                    <span>D√©faites</span>
                                    <span>{lossRate.toFixed(1)}%</span>
                                </div>
                                <div className="h-2 w-full overflow-hidden rounded-full bg-slate-800">
                                    <div
                                        className="h-full rounded-full bg-rose-500"
                                        style={{ width: `${lossRate}%` }}
                                    />
                                </div>
                            </div>
                        </div>

                        <div className="space-y-3 rounded-xl bg-slate-900/60 p-4">
                            <div className="flex items-center justify-between">
                                <p className="text-xs font-medium uppercase tracking-wide text-slate-400">
                                    Joueurs cl√©s
                                </p>
                                <span className="text-xs text-slate-500">
                                    Top {topPlayers.length} par importance
                                </span>
                            </div>
                            <ul className="space-y-2 text-sm">
                                {topPlayers.map(player => (
                                    <li
                                        key={player.name}
                                        className="rounded-lg bg-slate-900/80 px-3 py-2"
                                    >
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <p className="font-medium">{player.name}</p>
                                                <p className="text-xs text-slate-400">
                                                    {player.pos} ¬∑ {player.minutes.toLocaleString('fr-FR')} min
                                                </p>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-xs text-slate-400">
                                                    Note
                                                </p>
                                                <p className="text-sm font-semibold">
                                                    {player.rating.toFixed(1)}
                                                </p>
                                                <p className="text-[10px] text-slate-500">
                                                    Importance {player.importance.toFixed(1)}
                                                </p>
                                            </div>
                                        </div>
                                        {maxMinutes > 0 && (
                                            <div className="mt-2 h-1.5 w-full overflow-hidden rounded-full bg-slate-800">
                                                <div
                                                    className="h-full rounded-full bg-sky-500"
                                                    style={{
                                                        width: `${(player.minutes / maxMinutes) * 100}%`
                                                    }}
                                                />
                                            </div>
                                        )}
                                    </li>
                                ))}
                            </ul>
                        </div>

                        <div className="space-y-3 rounded-xl bg-slate-900/60 p-4">
                            <div className="flex items-center justify-between">
                                <p className="text-xs font-medium uppercase tracking-wide text-slate-400">
                                    Meilleures combinaisons (2 joueurs)
                                </p>
                                <span className="text-xs text-slate-500">
                                    Class√©es par points moyens
                                </span>
                            </div>
                            <ul className="space-y-2 text-sm">
                                {topCombos.map(combo => (
                                    <li
                                        key={combo.name}
                                        className="space-y-1 rounded-lg bg-slate-900/80 px-3 py-2"
                                    >
                                        <div className="flex items-center justify-between">
                                            <div className="pr-2">
                                                <p className="font-medium">{combo.name}</p>
                                                <p className="text-xs text-slate-400">
                                                    {combo.matches} matchs jou√©s
                                                </p>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-xs text-slate-400">
                                                    Pts/match
                                                </p>
                                                <p className="text-sm font-semibold">
                                                    {combo.avgPoints.toFixed(2)}
                                                </p>
                                                <p className="text-[10px] text-slate-500">
                                                    Score final {combo.avgScoreFinal.toFixed(1)}
                                                </p>
                                            </div>
                                        </div>
                                        <div className="h-1.5 w-full overflow-hidden rounded-full bg-slate-800">
                                            <div
                                                className="h-full rounded-full bg-emerald-500"
                                                style={{
                                                    width: `${Math.min(
                                                        (combo.avgPoints / 3) * 100,
                                                        100
                                                    )}%`
                                                }}
                                            />
                                        </div>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    </div>
                </div>
            );
        }

        function MatchesReactTable() {
            const { loading, error, rows } = useCsvData(
                'data/processed/ol_match_score_final.csv'
            );
            const [venueFilter, setVenueFilter] = useState('all');
            const [resultFilter, setResultFilter] = useState('all');
            const [sortBy, setSortBy] = useState('date_desc');

            if (loading) {
                return (
                    <div className="table-container">
                        <div className="loading">Chargement des matchs...</div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="table-container">
                        <div className="error">
                            Erreur lors du chargement des matchs: {error}
                        </div>
                    </div>
                );
            }

            let matches = rows || [];

            matches = matches.filter(m => {
                if (venueFilter === 'home' && m.venue !== 'Home') {
                    return false;
                }
                if (venueFilter === 'away' && m.venue !== 'Away') {
                    return false;
                }
                if (resultFilter === 'W' && m.result !== 'W') {
                    return false;
                }
                if (resultFilter === 'D' && m.result !== 'D') {
                    return false;
                }
                if (resultFilter === 'L' && m.result !== 'L') {
                    return false;
                }
                return true;
            });

            matches.sort((a, b) => {
                if (sortBy === 'date_asc') {
                    return new Date(a.date) - new Date(b.date);
                }
                if (sortBy === 'points_desc') {
                    return (parseInt(b.points || '0', 10) || 0) -
                        (parseInt(a.points || '0', 10) || 0);
                }
                if (sortBy === 'rating_desc') {
                    return (parseFloat(b.match_rating || '0') || 0) -
                        (parseFloat(a.match_rating || '0') || 0);
                }
                return new Date(b.date) - new Date(a.date);
            });

            const handleRowClick = match => {
                const content = `
                    <div class="match-details">
                        <h3>D√©tails du Match</h3>
                        <p><strong>Date:</strong> ${formatDate(match.date)}</p>
                        <p><strong>Adversaire:</strong> ${match.opponent || ''}</p>
                        <p><strong>Lieu:</strong> ${
                            match.venue === 'Home' ? 'Domicile' : 'Ext√©rieur'
                        }</p>
                        <p><strong>R√©sultat:</strong> ${
                            match.result === 'W'
                                ? 'Victoire'
                                : match.result === 'D'
                                ? 'Nul'
                                : 'D√©faite'
                        }</p>
                        <p><strong>Points:</strong> ${match.points || 0}</p>
                        <p><strong>Note:</strong> ${(
                            parseFloat(match.match_rating || 0) || 0
                        ).toFixed(1)}</p>
                        <p><strong>Score:</strong> ${match.score_final || ''}</p>
                    </div>
                `;
                createModal(`Match: OL vs ${match.opponent || ''}`, content);
            };

            return (
                <div className="space-y-4">
                    <div className="flex flex-wrap gap-3 rounded-xl bg-slate-900/60 p-4">
                        <div className="flex flex-col text-sm text-slate-200">
                            <label className="mb-1 text-xs text-slate-400">
                                Lieu
                            </label>
                            <select
                                className="rounded-md border border-slate-700 bg-slate-900 px-2 py-1 text-xs"
                                value={venueFilter}
                                onChange={e => setVenueFilter(e.target.value)}
                            >
                                <option value="all">Tous</option>
                                <option value="home">Domicile</option>
                                <option value="away">Ext√©rieur</option>
                            </select>
                        </div>
                        <div className="flex flex-col text-sm text-slate-200">
                            <label className="mb-1 text-xs text-slate-400">
                                R√©sultat
                            </label>
                            <select
                                className="rounded-md border border-slate-700 bg-slate-900 px-2 py-1 text-xs"
                                value={resultFilter}
                                onChange={e => setResultFilter(e.target.value)}
                            >
                                <option value="all">Tous</option>
                                <option value="W">Victoire</option>
                                <option value="D">Nul</option>
                                <option value="L">D√©faite</option>
                            </select>
                        </div>
                        <div className="flex flex-col text-sm text-slate-200">
                            <label className="mb-1 text-xs text-slate-400">
                                Tri
                            </label>
                            <select
                                className="rounded-md border border-slate-700 bg-slate-900 px-2 py-1 text-xs"
                                value={sortBy}
                                onChange={e => setSortBy(e.target.value)}
                            >
                                <option value="date_desc">Date d√©croissante</option>
                                <option value="date_asc">Date croissante</option>
                                <option value="points_desc">Points d√©croissants</option>
                                <option value="rating_desc">
                                    Note de match d√©croissante
                                </option>
                            </select>
                        </div>
                    </div>
                    <div className="table-container">
                        <table id="matches-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Adversaire</th>
                                    <th>Lieu</th>
                                    <th>R√©sultat</th>
                                    <th>Points</th>
                                    <th>Note</th>
                                    <th>Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                {matches.map(match => (
                                    <tr
                                        key={match.match_key || match.date + match.opponent}
                                        style={{ cursor: 'pointer' }}
                                        onClick={() => handleRowClick(match)}
                                    >
                                        <td>{formatDate(match.date)}</td>
                                        <td>{match.opponent || ''}</td>
                                        <td>
                                            {match.venue === 'Home'
                                                ? 'Domicile'
                                                : 'Ext√©rieur'}
                                        </td>
                                        <td>
                                            <span className={getResultBadge(match.result)}>
                                                {match.result === 'W'
                                                    ? 'Victoire'
                                                    : match.result === 'D'
                                                    ? 'Nul'
                                                    : 'D√©faite'}
                                            </span>
                                        </td>
                                        <td>{match.points || 0}</td>
                                        <td>
                                            {(
                                                parseFloat(match.match_rating || 0) || 0
                                            ).toFixed(1)}
                                        </td>
                                        <td>{match.score_final || ''}</td>
                                    </tr>
                                ))}
                                {matches.length === 0 && (
                                    <tr>
                                        <td colSpan="7" className="loading">
                                            Aucun match ne correspond aux filtres
                                        </td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function PlayersReactTable() {
            const { loading, error, rows } = useCsvData(
                'data/processed/ol_key_players.csv'
            );
            const [minMinutes, setMinMinutes] = useState(0);
            const [positionFilter, setPositionFilter] = useState('all');
            const [sortBy, setSortBy] = useState('importance_desc');

            if (loading) {
                return (
                    <div className="table-container">
                        <div className="loading">Chargement des joueurs...</div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="table-container">
                        <div className="error">
                            Erreur lors du chargement des joueurs: {error}
                        </div>
                    </div>
                );
            }

            const players = (rows || []).map(p => ({
                name: p.player,
                pos: p.pos,
                minutes: parseInt(p['Playing Time_Min'] || '0', 10) || 0,
                rating: parseFloat(p.rating || '0') || 0,
                importance: parseFloat(p.importance || '0') || 0,
                gls90: parseFloat(p['Per 90 Minutes_Gls'] || '0') || 0,
                ast90: parseFloat(p['Per 90 Minutes_Ast'] || '0') || 0,
                xg90: parseFloat(p['Per 90 Minutes_xG'] || '0') || 0,
                xag90: parseFloat(p['Per 90 Minutes_xAG'] || '0') || 0,
                prgC: parseFloat(p['Progression_PrgC'] || '0') || 0,
                prgP: parseFloat(p['Progression_PrgP'] || '0') || 0,
                prgR: parseFloat(p['Progression_PrgR'] || '0') || 0,
                cardsY: parseFloat(p['Performance_CrdY'] || '0') || 0,
                cardsR: parseFloat(p['Performance_CrdR'] || '0') || 0
            }));

            const distinctPositions = Array.from(
                new Set(
                    players
                        .map(p => (p.pos || '').split(','))
                        .flat()
                        .map(s => s.trim())
                        .filter(Boolean)
                )
            );

            let filtered = players.filter(p => p.name);

            filtered = filtered.filter(p => p.minutes >= minMinutes);

            if (positionFilter !== 'all') {
                filtered = filtered.filter(p =>
                    (p.pos || '').split(',').map(s => s.trim()).includes(positionFilter)
                );
            }

            filtered.sort((a, b) => {
                if (sortBy === 'minutes_desc') {
                    return b.minutes - a.minutes;
                }
                if (sortBy === 'rating_desc') {
                    return b.rating - a.rating;
                }
                return b.importance - a.importance;
            });

            const maxMinutes = players.reduce(
                (max, p) => (p.minutes > max ? p.minutes : max),
                0
            );

            const handleRowClick = player => {
                const content = `
                    <div class="player-details">
                        <h3>D√©tails du Joueur</h3>
                        <p><strong>Nom:</strong> ${player.name || ''}</p>
                        <p><strong>Position:</strong> ${player.pos || ''}</p>
                        <p><strong>Temps de Jeu:</strong> ${player.minutes.toLocaleString('fr-FR')} minutes</p>
                        <p><strong>Note:</strong> ${player.rating.toFixed(1)}</p>
                        <p><strong>Importance:</strong> ${player.importance.toFixed(2)}</p>
                        <hr>
                        <h4>Pourquoi cette note ?</h4>
                        <ul>
                            <li><strong>Production offensive (par 90):</strong> buts ${player.gls90.toFixed(2)}, passes ${player.ast90.toFixed(2)}</li>
                            <li><strong>Qualit√© des occasions (par 90):</strong> xG ${player.xg90.toFixed(2)}, xAG ${player.xag90.toFixed(2)}</li>
                            <li><strong>Progression du ballon:</strong> PrgC ${player.prgC.toFixed(0)}, PrgP ${player.prgP.toFixed(0)}, PrgR ${player.prgR.toFixed(0)}</li>
                            <li><strong>Discipline:</strong> jaunes ${player.cardsY.toFixed(0)}, rouges ${player.cardsR.toFixed(0)}</li>
                        </ul>
                        <p class="text-sm text-slate-500">
                            L'importance combine la note et le temps de jeu pour refl√©ter la contribution r√©elle sur la saison.
                        </p>
                    </div>
                `;
                createModal(`Joueur: ${player.name || ''}`, content);
            };

            return (
                <div className="space-y-4">
                    <div className="flex flex-wrap gap-3 rounded-xl bg-slate-900/60 p-4">
                        <div className="flex flex-col text-sm text-slate-200">
                            <label className="mb-1 text-xs text-slate-400">
                                Minutes minimum
                            </label>
                            <input
                                type="number"
                                min="0"
                                className="w-28 rounded-md border border-slate-700 bg-slate-900 px-2 py-1 text-xs"
                                value={minMinutes}
                                onChange={e =>
                                    setMinMinutes(
                                        Number.isNaN(parseInt(e.target.value, 10))
                                            ? 0
                                            : parseInt(e.target.value, 10)
                                    )
                                }
                            />
                        </div>
                        <div className="flex flex-col text-sm text-slate-200">
                            <label className="mb-1 text-xs text-slate-400">
                                Position
                            </label>
                            <select
                                className="rounded-md border border-slate-700 bg-slate-900 px-2 py-1 text-xs"
                                value={positionFilter}
                                onChange={e => setPositionFilter(e.target.value)}
                            >
                                <option value="all">Toutes</option>
                                {distinctPositions.map(pos => (
                                    <option key={pos} value={pos}>
                                        {pos}
                                    </option>
                                ))}
                            </select>
                        </div>
                        <div className="flex flex-col text-sm text-slate-200">
                            <label className="mb-1 text-xs text-slate-400">
                                Tri
                            </label>
                            <select
                                className="rounded-md border border-slate-700 bg-slate-900 px-2 py-1 text-xs"
                                value={sortBy}
                                onChange={e => setSortBy(e.target.value)}
                            >
                                <option value="importance_desc">
                                    Importance d√©croissante
                                </option>
                                <option value="minutes_desc">
                                    Minutes jou√©es d√©croissantes
                                </option>
                                <option value="rating_desc">
                                    Note d√©croissante
                                </option>
                            </select>
                        </div>
                    </div>
                    <div className="table-container">
                        <table id="players-table">
                            <thead>
                                <tr>
                                    <th>Joueur</th>
                                    <th>Position</th>
                                    <th>Temps de Jeu (min)</th>
                                    <th>Note</th>
                                    <th>Importance</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filtered.map(player => (
                                    <tr
                                        key={player.name}
                                        style={{ cursor: 'pointer' }}
                                        onClick={() => handleRowClick(player)}
                                    >
                                        <td>{player.name}</td>
                                        <td>{player.pos}</td>
                                        <td>{player.minutes.toLocaleString('fr-FR')}</td>
                                        <td>{player.rating.toFixed(1)}</td>
                                        <td>
                                            <div className="flex items-center gap-2">
                                                <span>
                                                    {player.importance.toFixed(2)}
                                                </span>
                                                {maxMinutes > 0 && (
                                                    <div className="h-1.5 w-24 overflow-hidden rounded-full bg-slate-800">
                                                        <div
                                                            className="h-full rounded-full bg-emerald-500"
                                                            style={{
                                                                width: `${Math.min(
                                                                    (player.minutes /
                                                                        maxMinutes) *
                                                                        100,
                                                                    100
                                                                )}%`
                                                            }}
                                                        />
                                                    </div>
                                                )}
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                                {filtered.length === 0 && (
                                    <tr>
                                        <td colSpan="5" className="loading">
                                            Aucun joueur ne correspond aux filtres
                                        </td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function CombosAdvancedReactView() {
            const { loading, error, rows } = useCsvData(
                'data/processed/ol_best_combos_ALL_3_to_11.csv'
            );
            const [minMatches, setMinMatches] = useState(3);
            const [playerFilter, setPlayerFilter] = useState('');
            const [sizeFilter, setSizeFilter] = useState('all');
            const [sortBy, setSortBy] = useState('points_desc');

            if (loading) {
                return (
                    <div className="mt-4 rounded-2xl border border-slate-700 bg-slate-900/80 px-6 py-4 text-slate-100">
                        Chargement des combinaisons avanc√©es...
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="mt-4 rounded-2xl border border-red-500/60 bg-red-900/40 px-6 py-4 text-sm text-red-100">
                        Erreur lors du chargement des combinaisons: {error}
                    </div>
                );
            }

            const combos = (rows || [])
                .map(c => ({
                    name: c.combo,
                    size:
                        parseInt(c.size || c.combo_size || '0', 10) ||
                        0,
                    matches: parseInt(c.matches || '0', 10) || 0,
                    avgPoints: parseFloat(c.avg_points || '0') || 0,
                    avgScoreFinal:
                        parseFloat(c.avg_score_final || '0') || 0
                }))
                .filter(c => c.name);

            const availableSizes = Array.from(
                new Set(
                    combos
                        .map(c => c.size)
                        .filter(size => Number.isFinite(size) && size > 0)
                )
            ).sort((a, b) => a - b);

            const normalizedFilter = playerFilter
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .toLowerCase();

            let filtered = combos.filter(c => c.matches >= minMatches);

            if (normalizedFilter) {
                filtered = filtered.filter(c =>
                    c.name
                        .normalize('NFD')
                        .replace(/[\u0300-\u036f]/g, '')
                        .toLowerCase()
                        .includes(normalizedFilter)
                );
            }

            if (sizeFilter !== 'all') {
                const sizeNumber = parseInt(sizeFilter, 10) || 0;
                if (sizeNumber > 0) {
                    filtered = filtered.filter(c => c.size === sizeNumber);
                }
            }

            filtered.sort((a, b) => {
                if (sortBy === 'score_desc') {
                    return b.avgScoreFinal - a.avgScoreFinal;
                }
                if (sortBy === 'matches_desc') {
                    return b.matches - a.matches;
                }
                return b.avgPoints - a.avgPoints;
            });

            const displayed = filtered.slice(0, 30);

            const maxAvgPoints = filtered.reduce(
                (max, c) => (c.avgPoints > max ? c.avgPoints : max),
                0
            );

            const bestCombo = filtered[0];

            if (!combos.length) {
                return (
                    <div className="mt-4 rounded-2xl border border-slate-700 bg-slate-900/80 px-6 py-4 text-slate-100">
                        Aucune combinaison disponible.
                    </div>
                );
            }

            return (
                <div className="mt-6 space-y-6 rounded-2xl border border-slate-700 bg-slate-900/80 p-6 text-slate-100">
                    <div className="flex flex-col gap-4 md:flex-row md:items-baseline md:justify-between">
                        <div>
                            <p className="text-xs uppercase tracking-wide text-slate-400">
                                Combinaisons de 2 √† 11 joueurs
                            </p>
                            <h3 className="text-lg font-semibold">
                                Vue avanc√©e des combinaisons OL
                            </h3>
                            <p className="mt-1 text-xs text-slate-400">
                                Filtrez par joueur, nombre de matchs et m√©triques avanc√©es.
                            </p>
                        </div>
                        <div className="text-right text-xs text-slate-400">
                            <p>Total de combinaisons: {combos.length}</p>
                            <p>Affich√©es: {displayed.length}</p>
                        </div>
                    </div>

                    {bestCombo && (
                        <div className="grid gap-4 rounded-xl bg-slate-900/70 p-4 md:grid-cols-3">
                            <div className="md:col-span-2">
                                <p className="text-xs uppercase tracking-wide text-amber-400">
                                    Meilleure combinaison actuelle
                                </p>
                                <p className="mt-1 text-sm font-semibold">
                                    {bestCombo.name}
                                </p>
                                <p className="mt-1 text-xs text-slate-400">
                                    Taille: {bestCombo.size} joueurs ¬∑{' '}
                                    {bestCombo.matches} matchs
                                </p>
                            </div>
                            <div className="flex items-center justify-end gap-6 text-sm">
                                <div className="text-right">
                                    <p className="text-xs text-slate-400">
                                        Points moyens
                                    </p>
                                    <p className="text-xl font-semibold text-emerald-300">
                                        {bestCombo.avgPoints.toFixed(2)}
                                    </p>
                                </div>
                                <div className="text-right">
                                    <p className="text-xs text-slate-400">
                                        Score final moyen
                                    </p>
                                    <p className="text-xl font-semibold text-sky-300">
                                        {bestCombo.avgScoreFinal.toFixed(1)}
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="flex flex-wrap gap-3 rounded-xl bg-slate-900/60 p-4">
                        <div className="flex flex-col text-sm text-slate-200">
                            <label className="mb-1 text-xs text-slate-400">
                                Matchs minimum
                            </label>
                            <input
                                type="number"
                                min="1"
                                className="w-24 rounded-md border border-slate-700 bg-slate-900 px-2 py-1 text-xs"
                                value={minMatches}
                                onChange={e =>
                                    setMinMatches(
                                        Number.isNaN(
                                            parseInt(e.target.value, 10)
                                        )
                                            ? 1
                                            : parseInt(e.target.value, 10)
                                    )
                                }
                            />
                        </div>
                        <div className="flex flex-col text-sm text-slate-200">
                            <label className="mb-1 text-xs text-slate-400">
                                Filtrer par joueur
                            </label>
                            <input
                                type="text"
                                className="w-52 rounded-md border border-slate-700 bg-slate-900 px-2 py-1 text-xs"
                                placeholder="Ex: Tagliafico, Fofana..."
                                value={playerFilter}
                                onChange={e =>
                                    setPlayerFilter(e.target.value)
                                }
                            />
                        </div>
                        <div className="flex flex-col text-sm text-slate-200">
                            <label className="mb-1 text-xs text-slate-400">
                                Taille de combinaison
                            </label>
                            <select
                                className="rounded-md border border-slate-700 bg-slate-900 px-2 py-1 text-xs"
                                value={sizeFilter}
                                onChange={e => setSizeFilter(e.target.value)}
                            >
                                <option value="all">Toutes</option>
                                {availableSizes.map(size => (
                                    <option key={size} value={String(size)}>
                                        {size} joueurs
                                    </option>
                                ))}
                            </select>
                        </div>
                        <div className="flex flex-col text-sm text-slate-200">
                            <label className="mb-1 text-xs text-slate-400">
                                Tri
                            </label>
                            <select
                                className="rounded-md border border-slate-700 bg-slate-900 px-2 py-1 text-xs"
                                value={sortBy}
                                onChange={e => setSortBy(e.target.value)}
                            >
                                <option value="points_desc">
                                    Points moyens d√©croissants
                                </option>
                                <option value="score_desc">
                                    Score final moyen d√©croissant
                                </option>
                                <option value="matches_desc">
                                    Matchs jou√©s d√©croissants
                                </option>
                            </select>
                        </div>
                    </div>

                    <div className="table-container">
                        <table className="w-full text-left text-sm">
                            <thead>
                                <tr className="border-b border-slate-800 text-xs text-slate-400">
                                    <th className="px-3 py-2">
                                        Combinaison
                                    </th>
                                    <th className="px-3 py-2 text-center">
                                        Taille
                                    </th>
                                    <th className="px-3 py-2 text-center">
                                        Matchs
                                    </th>
                                    <th className="px-3 py-2 text-center">
                                        Points moyens
                                    </th>
                                    <th className="px-3 py-2 text-center">
                                        Score final moyen
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {displayed.map(combo => (
                                    <tr
                                        key={combo.name}
                                        className="border-b border-slate-800/60 align-middle"
                                    >
                                        <td className="px-3 py-2">
                                            {combo.name}
                                        </td>
                                        <td className="px-3 py-2 text-center">
                                            {combo.size}
                                        </td>
                                        <td className="px-3 py-2 text-center">
                                            {combo.matches}
                                        </td>
                                        <td className="px-3 py-2">
                                            <div className="flex items-center justify-center gap-2">
                                                <span>
                                                    {combo.avgPoints.toFixed(2)}
                                                </span>
                                                {maxAvgPoints > 0 && (
                                                    <div className="h-1.5 w-24 overflow-hidden rounded-full bg-slate-800">
                                                        <div
                                                            className="h-full rounded-full bg-emerald-500"
                                                            style={{
                                                                width: `${Math.min(
                                                                    (combo.avgPoints /
                                                                        maxAvgPoints) *
                                                                        100,
                                                                    100
                                                                )}%`
                                                            }}
                                                        />
                                                    </div>
                                                )}
                                            </div>
                                        </td>
                                        <td className="px-3 py-2 text-center">
                                            {combo.avgScoreFinal.toFixed(1)}
                                        </td>
                                    </tr>
                                ))}
                                {displayed.length === 0 && (
                                    <tr>
                                        <td
                                            colSpan="5"
                                            className="px-3 py-4 text-center text-sm text-slate-400"
                                        >
                                            Aucune combinaison ne correspond
                                            aux filtres.
                                        </td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function StandingsReactSummary() {
            const { loading, error, rows } = useCsvData(
                'data/processed/league1_standings_home_away.csv'
            );

            if (loading) {
                return (
                    <div className="mb-6 rounded-2xl border border-slate-700 bg-slate-900/80 px-6 py-4 text-slate-100">
                        Synth√®se du classement en cours de chargement...
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="mb-6 rounded-2xl border border-red-500/60 bg-red-900/40 px-6 py-4 text-sm text-red-100">
                        Erreur lors du chargement du classement: {error}
                    </div>
                );
            }

            const teams = (rows || []).filter(
                t =>
                    t.team &&
                    !t.team
                        .toLowerCase()
                        .includes('choc des olympiques')
            );

            if (!teams.length) {
                return (
                    <div className="mb-6 rounded-2xl border border-slate-700 bg-slate-900/80 px-6 py-4 text-slate-100">
                        Donn√©es de classement indisponibles.
                    </div>
                );
            }

            const lyonExact = teams.find(t => t.team === 'Lyon');
            const lyonFallback = teams.find(t =>
                t.team.toLowerCase().includes('lyon')
            );
            const lyon = lyonExact || lyonFallback || null;

            const sortedByRank = [...teams].sort(
                (a, b) =>
                    (parseInt(a.rank || '999', 10) || 999) -
                    (parseInt(b.rank || '999', 10) || 999)
            );

            const leader = sortedByRank[0];

            const lyonRank = lyon
                ? parseInt(lyon.rank || '0', 10) || 0
                : null;
            const lyonPoints = lyon
                ? parseInt(lyon.points || '0', 10) || 0
                : 0;
            const lyonPointsPerMatch = lyon
                ? parseFloat(lyon.points_per_match || '0') || 0
                : 0;
            const lyonWinRate = lyon
                ? parseFloat(lyon.win_rate || '0') || 0
                : 0;
            const lyonGoalsForPerMatch = lyon
                ? parseFloat(lyon.goals_for_per_match || '0') || 0
                : 0;
            const lyonGoalsAgainstPerMatch = lyon
                ? parseFloat(lyon.goals_against_per_match || '0') || 0
                : 0;

            const lyonHomePointsPerMatch = lyon
                ? parseFloat(lyon.home_points_per_match || '0') || 0
                : 0;
            const lyonAwayPointsPerMatch = lyon
                ? parseFloat(lyon.away_points_per_match || '0') || 0
                : 0;

            const leaderPoints = leader
                ? parseInt(leader.points || '0', 10) || 0
                : 0;
            const leaderPointsPerMatch = leader
                ? parseFloat(leader.points_per_match || '0') || 0
                : 0;

            const pointsGap =
                lyon && leader ? leaderPoints - lyonPoints : 0;
            const rankGap =
                lyonRank && leader ? lyonRank - (parseInt(leader.rank || '1', 10) || 1) : 0;

            const maxPointsPerMatchInLeague = teams.reduce(
                (max, t) => {
                    const v =
                        parseFloat(t.points_per_match || '0') || 0;
                    return v > max ? v : max;
                },
                0
            );

            const displayTeamName = lyon ? lyon.team : 'Lyon';

            const topThree = sortedByRank.slice(0, 3);

            return (
                <div className="mb-6 space-y-4 rounded-2xl border border-slate-700 bg-slate-900/80 p-6 text-slate-100">
                    <div className="flex flex-col gap-4 md:flex-row md:items-baseline md:justify-between">
                        <div>
                            <p className="text-xs uppercase tracking-wide text-slate-400">
                                Synth√®se Ligue 1
                            </p>
                            <h3 className="text-lg font-semibold">
                                Position actuelle de {displayTeamName}
                            </h3>
                            {lyonRank && (
                                <p className="mt-1 text-xs text-slate-400">
                                    {displayTeamName} est {lyonRank}
                                    e sur {teams.length} √©quipes.
                                </p>
                            )}
                        </div>
                        {leader && (
                            <div className="text-right text-xs text-slate-400">
                                <p>Leader actuel: {leader.team}</p>
                                <p>
                                    {leaderPoints} pts ¬∑{' '}
                                    {leaderPointsPerMatch.toFixed(2)} pts/m
                                </p>
                            </div>
                        )}
                    </div>

                    <div className="grid gap-4 md:grid-cols-3">
                        <div className="space-y-3 rounded-xl bg-slate-900/70 p-4">
                            <p className="text-xs font-medium uppercase tracking-wide text-slate-400">
                                Global
                            </p>
                            <p className="text-3xl font-semibold">
                                {lyonPoints} pts
                            </p>
                            <p className="text-xs text-slate-400">
                                {lyonPointsPerMatch.toFixed(2)} pts/match ¬∑{' '}
                                {lyonWinRate.toFixed(1)}% victoires
                            </p>
                            <div className="mt-3 space-y-2 text-xs text-slate-400">
                                <div className="flex items-center justify-between">
                                    <span>Attaque</span>
                                    <span>
                                        {lyonGoalsForPerMatch.toFixed(2)} buts/m
                                    </span>
                                </div>
                                <div className="h-1.5 w-full overflow-hidden rounded-full bg-slate-800">
                                    <div
                                        className="h-full rounded-full bg-emerald-500"
                                        style={{
                                            width: `${Math.min(
                                                (lyonGoalsForPerMatch / 3) *
                                                    100,
                                                100
                                            )}%`
                                        }}
                                    />
                                </div>
                                <div className="flex items-center justify-between">
                                    <span>D√©fense</span>
                                    <span>
                                        {lyonGoalsAgainstPerMatch.toFixed(2)} buts/m
                                    </span>
                                </div>
                                <div className="h-1.5 w-full overflow-hidden rounded-full bg-slate-800">
                                    <div
                                        className="h-full rounded-full bg-rose-500"
                                        style={{
                                            width: `${Math.min(
                                                (lyonGoalsAgainstPerMatch /
                                                    3) *
                                                    100,
                                                100
                                            )}%`
                                        }}
                                    />
                                </div>
                            </div>
                        </div>

                        <div className="space-y-3 rounded-xl bg-slate-900/70 p-4">
                            <p className="text-xs font-medium uppercase tracking-wide text-slate-400">
                                Domicile vs ext√©rieur
                            </p>
                            <div className="space-y-3">
                                <div>
                                    <div className="flex items-center justify-between text-xs text-slate-400">
                                        <span>Domicile</span>
                                        <span>
                                            {lyonHomePointsPerMatch.toFixed(2)} pts/m
                                        </span>
                                    </div>
                                    <div className="mt-1 h-1.5 w-full overflow-hidden rounded-full bg-slate-800">
                                        <div
                                            className="h-full rounded-full bg-sky-500"
                                            style={{
                                                width: `${maxPointsPerMatchInLeague > 0 ? Math.min(
                                                    (lyonHomePointsPerMatch /
                                                        maxPointsPerMatchInLeague) *
                                                        100,
                                                    100
                                                ) : 0}%`
                                            }}
                                        />
                                    </div>
                                </div>
                                <div>
                                    <div className="flex items-center justify-between text-xs text-slate-400">
                                        <span>Ext√©rieur</span>
                                        <span>
                                            {lyonAwayPointsPerMatch.toFixed(2)} pts/m
                                        </span>
                                    </div>
                                    <div className="mt-1 h-1.5 w-full overflow-hidden rounded-full bg-slate-800">
                                        <div
                                            className="h-full rounded-full bg-amber-400"
                                            style={{
                                                width: `${maxPointsPerMatchInLeague > 0 ? Math.min(
                                                    (lyonAwayPointsPerMatch /
                                                        maxPointsPerMatchInLeague) *
                                                        100,
                                                    100
                                                ) : 0}%`
                                            }}
                                        />
                                    </div>
                                </div>
                            </div>
                            {rankGap !== null && lyonRank && (
                                <p className="mt-3 text-xs text-slate-400">
                                    √âcart avec le leader:{' '}
                                    {pointsGap >= 0
                                        ? `${pointsGap} pts`
                                        : `${-pointsGap} pts d'avance`}{' '}
                                    ¬∑ {rankGap > 0 ? `${rankGap} places` : 'Leader'}
                                </p>
                            )}
                        </div>

                        <div className="space-y-3 rounded-xl bg-slate-900/70 p-4">
                            <p className="text-xs font-medium uppercase tracking-wide text-slate-400">
                                Top 3 du championnat
                            </p>
                            <ul className="space-y-2 text-sm">
                                {topThree.map(team => (
                                    <li
                                        key={team.team}
                                        className="flex items-center justify-between rounded-lg bg-slate-900/80 px-3 py-2"
                                    >
                                        <div>
                                            <p className="font-medium">
                                                {team.rank}. {team.team}
                                            </p>
                                            <p className="text-xs text-slate-400">
                                                {parseInt(team.points || '0', 10) ||
                                                    0}{' '}
                                                pts ¬∑{' '}
                                                {(
                                                    parseFloat(
                                                        team.points_per_match ||
                                                            '0'
                                                    ) || 0
                                                ).toFixed(2)}{' '}
                                                pts/m
                                            </p>
                                        </div>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    </div>
                </div>
            );
        }

        const mainRoot = document.getElementById('react-root');
        if (mainRoot && window.ReactDOM && ReactDOM.createRoot) {
            ReactDOM.createRoot(mainRoot).render(<MatchAnalysisDashboard />);
        }

        const matchesRoot = document.getElementById('matches-react-root');
        if (matchesRoot && window.ReactDOM && ReactDOM.createRoot) {
            ReactDOM.createRoot(matchesRoot).render(<MatchesReactTable />);
        }

        const playersRoot = document.getElementById('players-react-root');
        if (playersRoot && window.ReactDOM && ReactDOM.createRoot) {
            ReactDOM.createRoot(playersRoot).render(<PlayersReactTable />);
        }

        const combosRoot = document.getElementById('combos-react-root');
        if (combosRoot && window.ReactDOM && ReactDOM.createRoot) {
            ReactDOM.createRoot(combosRoot).render(
                <CombosAdvancedReactView />
            );
        }

        const standingsRoot = document.getElementById('standings-react-root');
        if (standingsRoot && window.ReactDOM && ReactDOM.createRoot) {
            ReactDOM.createRoot(standingsRoot).render(
                <StandingsReactSummary />
            );
        }
    </script>
</body>
</html>
